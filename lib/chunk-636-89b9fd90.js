"use strict";(globalThis.webpackChunk_croquet_microverse=globalThis.webpackChunk_croquet_microverse||[]).push([[636],{8636:(e,t,s)=>{s.r(t),s.d(t,{default:()=>i});const i={modules:[{name:"PDFView",actorBehaviors:[class PDFActor{setup(){this.setupRun||(this.setupRun=!0,this.numPages=null,this.scrollPosition=null,this.PAGE_GAP_PERCENT=4,this.listen("docLoaded","docLoaded"),this.listen("changePage","changePage"),this.listen("scrollByPercent","scrollByPercent"),console.log(this))}viewJoined(e){}viewExited(e){}docLoaded(e){this.numPages=e.numPages,null===this.scrollPosition&&(this.scrollPosition={page:1,percent:0}),this.say("drawAtScrollPosition")}changePage(e){let{page:t,percent:s}=this.scrollPosition;(0<e||s<=0)&&(t+=e),0===t?t=this.numPages:t>this.numPages&&(t=1),s=0,this.scrollPosition={page:t,percent:s},this.say("drawAtScrollPosition")}scrollByPercent(e){var{page:t,percent:s}=this.scrollPosition;let{page:i,percent:a}=this.scrollPosition;var r=this.PAGE_GAP_PERCENT;a+=e,1===i&&a<0?a=0:i===this.numPages&&90<a?a=90:a<-r?(i--,a+=100+r):100<a&&(i++,a-=100+r),i===t&&a===s||(this.scrollPosition={page:i,percent:a},this.say("drawAtScrollPosition"))}}],pawnBehaviors:[class PDFPawn{setup(){if(window.pdfjsPromise||(window.pdfjsPromise=new Promise(t=>{const e=document.createElement("script");e.setAttribute("src","https://mozilla.github.io/pdf.js/build/pdf.js"),e.onload=()=>{const e=window["pdfjs-dist/build/pdf"];e.GlobalWorkerOptions.workerSrc="//mozilla.github.io/pdf.js/build/pdf.worker.js",t(e)},document.body.appendChild(e)})),!this.setupRun){this.setupRun=!0,this.threeObj=this.shape.children.find(e=>"2d"===e.name),this.addEventListener("pointerDown","onPointerDown"),this.addEventListener("keyDown","onKeyDown"),this.addEventListener("pointerWheel","onPointerWheel"),this.renderedPage=null,this.listen("drawAtScrollPosition","drawAtScrollPosition");const t=this.canvas=document.createElement("canvas");t.id=this.actor._cardData.name||this.id,this.context=t.getContext("2d"),this.texture=this.threeObj.material[0].map=new THREE.CanvasTexture(this.canvas),console.log(this),this.pages=[],this.visiblePages=[],this.renderQueue=[],this.renderingPage=!1,this.loadDocument(this.actor._cardData.pdfLocation).then(()=>{this.ensurePageEntry(1)});var e=this._behavior.module.externalName;this.addUpdateRequest([e+"$PDFPawn","update"])}}async loadDocument(e){e=await this.getBuffer(e),e=URL.createObjectURL(new Blob([e]));try{const s=await window.pdfjsPromise;this.pdf=await s.getDocument(e).promise;var t=this.pdf.numPages;console.log(`PDF with ${t} pages loaded`),this.actor.numPages||this.say("docLoaded",{numPages:t})}catch(e){console.error(e.message)}URL.revokeObjectURL(e)}drawAtScrollPosition(){if(this.pdf&&this.PAGE_GAP){var{numPages:a,scrollPosition:r}=this.actor;if(a){const{canvas:p,context:m}=this;var{width:n,height:h}=p,{page:a,percent:r}=(m.fillStyle="#888",m.fillRect(0,0,n,h),this.texture.needsUpdate=!0,r);let e=a,t=r/100,s=!1,i=0;for(;!s;){var{renderResult:o,renderWidth:l,renderHeight:d}=this.ensurePageEntry(e);if(void 0===d)return;var c,g,u,P=Math.floor(t*d);o&&(l=Math.min(l,n),c=Math.max(0,P),g=P<0?-P:i,u=Math.min(d-c,h-g),m.putImageData(o,0,g-c,0,c,l,u)),i+=Math.ceil(d-P+this.PAGE_GAP),e===this.actor.numPages||i>=h?s=!0:(e++,t=0)}}}}updateVisiblePages(){var i=this.actor["scrollPosition"];if(i&&this.PAGE_GAP){var{page:i,percent:a}=i,r=this.visiblePages;const h=this.visiblePages=[];let e=i,t=a/100,s=0;for(;;){if(r[e]?h[e]=r[e]:h[e]=Date.now(),e===this.actor.numPages)return;var n=this.ensurePageEntry(e)["renderHeight"];if(void 0===n)return;if((s+=n-t*n+this.PAGE_GAP)>=this.canvas.height)return;e++,t=0}}}populateRenderQueue(){var e=this.actor["scrollPosition"];if(e&&this.PAGE_GAP){const i=e["page"],a=this.actor["numPages"],r=this.renderQueue=[];var t=e=>{e<1?e+=a:e>a&&(e-=a);var t=this.ensurePageEntry(e);t.page&&!t.renderTask&&r.push(e)},s=Math.min(a,4);for(let e=1;e<s;e++)t(i+e),t(i-e);this.pages.forEach((e,t)=>{t!==i&&e.renderResult&&5<(t>i?Math.min(t-i,i+a-t):Math.min(i-t,t+a-i))&&(e.renderResult=null,e.renderTask=null)})}}processRenderQueue(){const e=this.visiblePages;if(!this.renderingPage||!e[this.renderingPage]){const i=!1===this.renderingPage?0:200,a=Date.now();if(e.forEach((e,t)=>{a-e<i||(e=this.ensurePageEntry(t)).page&&!e.renderTask&&this.startRendering(t)}),!this.renderingPage){const r=this.renderQueue;var t,s;0!==r.length&&(t=r[0],(s=this.ensurePageEntry(t)).page&&(r.shift(),s.renderTask||this.startRendering(t)))}}}startRendering(e){if(this.renderingPage){const t=this.ensurePageEntry(this.renderingPage);t.renderTask.cancel()}this.renderingPage=e;const t=this.ensurePageEntry(e),{page:s,renderScale:i}=t,a=s.getViewport({scale:i}),r=(this.renderCanvas||(this.renderCanvas=document.createElement("canvas")),this.renderCanvas),n=r.getContext("2d");r.height=a.height,r.width=a.width;var h={canvasContext:n,viewport:a};const o=t.renderTask=s.render(h);o.promise.then(()=>{this.renderingPage=null,t.renderResult=n.getImageData(0,0,a.width,a.height),this.finishedRendering(e)},()=>{t.renderTask=null})}finishedRendering(e){this.visiblePages[e]&&this.drawAtScrollPosition()}adjustCardSize(e,t){var{depth:s,cornerRadius:i}=this.actor._cardData,a=Math.max(e,t),r=1/a;const n=this.threeObj;n.geometry.dispose(),n.geometry=this.roundedCornerGeometry(e*r,t*r,s,i);r=4096/a*.999;this.canvas.width=r*e,this.canvas.height=r*t,n.material[0].map.dispose(),this.texture=n.material[0].map=new THREE.CanvasTexture(this.canvas),this.PAGE_GAP=Math.floor(r*t*this.actor.PAGE_GAP_PERCENT/100)}ensurePageEntry(r){var e=this.pages[r];if(e)return e;const n={renderResult:null,renderTask:null};return this.pages[r]=n,this.pdf.getPage(r).then(e=>{var{width:t,height:s}=(n.page=e).getViewport({scale:1}),i=(n.width=t,n.height=s,4096/Math.max(t,s)*.999),{width:e,height:a}=e.getViewport({scale:i});n.renderScale=i,n.renderWidth=Math.floor(e),n.renderHeight=Math.floor(a),1===r&&this.adjustCardSize(t,s)}),n}onPointerDown(e){e.uv&&this.changePage(1)}onPointerWheel(e){if(this.pdf&&this.PAGE_GAP){var t=Date.now();if(this.cumulativeWheelDelta=(this.cumulativeWheelDelta||0)+e.deltaY,!(t-(this.lastPointerWheel||0)<50)){this.lastPointerWheel=t;let e=4*this.cumulativeWheelDelta/this.canvas.height*100;50<Math.abs(e)&&(e=50*Math.sign(e)),this.cumulativeWheelDelta=0,this.say("scrollByPercent",e)}}}onKeyDown(e){if(!e.repeat)switch(e.key){case"ArrowLeft":case"ArrowUp":this.changePage(-1);break;case"ArrowRight":case"ArrowDown":this.changePage(1)}}changePage(e){this.say("changePage",e)}onKeyUp(e){}update(){this.updateVisiblePages(),this.populateRenderQueue(),this.processRenderQueue()}destroy(){const e=this.threeObj;e.geometry.dispose(),e.material[0].map.dispose(),this.material.dispose()}}]}]}}}]);