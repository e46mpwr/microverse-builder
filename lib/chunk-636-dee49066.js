"use strict";(globalThis.webpackChunk_croquet_microverse=globalThis.webpackChunk_croquet_microverse||[]).push([[636],{8636:(e,t,s)=>{s.r(t),s.d(t,{default:()=>i});const i={modules:[{name:"PDFView",actorBehaviors:[class PDFActor{setup(){this.setupRun||(this.setupRun=!0,this.numPages=null,this.scrollPosition=null,this.PAGE_GAP_PERCENT=4,this.listen("docLoaded","docLoaded"),this.listen("changePage","changePage"),this.listen("scrollByPercent","scrollByPercent"),console.log(this))}viewJoined(e){}viewExited(e){}docLoaded(e){this.numPages=e.numPages,null===this.scrollPosition&&(this.scrollPosition={page:1,percent:0}),this.say("drawAtScrollPosition")}changePage(e){let{page:t,percent:s}=this.scrollPosition;(0<e||s<=0)&&(t+=e),0===t?t=this.numPages:t>this.numPages&&(t=1),s=0,this.scrollPosition={page:t,percent:s},this.say("drawAtScrollPosition")}scrollByPercent(e){var{page:t,percent:s}=this.scrollPosition;let{page:i,percent:a}=this.scrollPosition;var r=this.PAGE_GAP_PERCENT;a+=e,1===i&&a<0?a=0:i===this.numPages&&90<a?a=90:a<-r?(i--,a+=100+r):100<a&&(i++,a-=100+r),i===t&&a===s||(this.scrollPosition={page:i,percent:a},this.say("drawAtScrollPosition"))}}],pawnBehaviors:[class PDFPawn{setup(){var e;window.pdfjsPromise||(window.pdfjsPromise=new Promise(t=>{const e=document.createElement("script");e.setAttribute("src","https://mozilla.github.io/pdf.js/build/pdf.js"),e.onload=()=>{const e=window["pdfjs-dist/build/pdf"];e.GlobalWorkerOptions.workerSrc="//mozilla.github.io/pdf.js/build/pdf.worker.js",t(e)},document.body.appendChild(e)})),this.setupRun||(this.setupRun=!0,this.addEventListener("pointerDown","onPointerDown"),this.addEventListener("keyDown","onKeyDown"),this.addEventListener("pointerWheel","onPointerWheel"),this.listen("drawAtScrollPosition","drawAtScrollPosition"),console.log(this),this.substrateObj=this.shape.children.find(e=>"2d"===e.name),this.TEXTURE_SIZE=4096,this.pages=[],this.visiblePages=[],this.renderQueue=[],this.renderingPage=!1,this.pageMeshPool=[],this.loadDocument(this.actor._cardData.pdfLocation).then(()=>{this.ensurePageEntry(1)}),e=this._behavior.module.externalName,this.addUpdateRequest([e+"$PDFPawn","update"]))}async loadDocument(e){e=await this.getBuffer(e),e=URL.createObjectURL(new Blob([e]));try{const s=await window.pdfjsPromise;this.pdf=await s.getDocument(e).promise;var t=this.pdf.numPages;console.log(`PDF with ${t} pages loaded`),this.actor.numPages||this.say("docLoaded",{numPages:t})}catch(e){console.error(e.message)}URL.revokeObjectURL(e)}drawAtScrollPosition(){if(this.pdf&&this.PAGE_GAP){var{numPages:e,scrollPosition:t}=this.actor;if(e){const p=this.pageMeshPool;this.shape.children.slice().forEach(e=>{"page"===e.name&&(this.shape.remove(e),p.push(e))}),p.forEach(e=>{this.visiblePages[e.lastAssignedPage]||delete e.lastAssignedPage});var r=this.actor._cardData["depth"],{cardWidth:n,cardHeight:o}=this,{page:e,percent:t}=t;let s=e,i=t/100,a=0;for(;;){const m=this.ensurePageEntry(s);var{renderResult:h,aspectRatio:d}=m;if(void 0===d)return;d=n/d;if(h){let e,t=p.findIndex(e=>e.lastAssignedPage===s);t<0&&(t=p.findIndex(e=>!e.lastAssignedPage)),(e=t<0?this.makePageMesh():p.splice(t,1)[0]).lastAssignedPage=s,e.geometry.dispose();var l=Math.max(0,i),c=i<0?-i*o:0,g=Math.min((1-l)*d,o-a-c),u=l+g/d,P=e.geometry=new THREE.PlaneGeometry(n,g),c=(this.shape.add(e),o/2-a-c-g/2);e.position.set(0,c,r/2+.001);const E=P.attributes.uv;E.setXY(0,0,1-l),E.setXY(1,1,1-l),E.setXY(2,0,1-u),E.setXY(3,1,1-u),E.needsUpdate=!0,m.texture||(m.texture=new THREE.Texture(h)),e.material.map!==m.texture&&(e.material.map=m.texture,m.texture.needsUpdate=!0)}if(a+=d-d*i+this.PAGE_GAP,s===this.actor.numPages||a>=o)return;s++,i=0}}}}makePageMesh(){var{cardWidth:e,cardHeight:t}=this,e=new THREE.PlaneGeometry(e,t),t=new THREE.MeshBasicMaterial({color:"#fff",side:THREE.DoubleSide});const s=new THREE.Mesh(e,t);return s.name="page",s}updateVisiblePages(){var i=this.actor["scrollPosition"];if(i&&this.PAGE_GAP){var{page:i,percent:a}=i,{cardWidth:r,cardHeight:n}=this,o=this.visiblePages;const d=this.visiblePages=[];let e=i,t=a/100,s=0;for(;;){if(o[e]?d[e]=o[e]:d[e]=Date.now(),e===this.actor.numPages)return;var h=this.ensurePageEntry(e)["aspectRatio"];if(void 0===h)return;h=r/h;if((s+=h-t*h+this.PAGE_GAP)>=n)return;e++,t=0}}}manageRenderState(){var e=this.actor["scrollPosition"];if(e&&this.PAGE_GAP){const i=e["page"],a=this.actor["numPages"],r=this.renderQueue=[];var t=e=>{e<1?e+=a:e>a&&(e-=a);var t=this.ensurePageEntry(e);t.page&&!t.renderTask&&r.push(e)},s=Math.min(a,4);for(let e=1;e<s;e++)t(i+e),t(i-e);this.pages.forEach((e,t)=>{var s;t!==i&&(s=!!this.visiblePages[t],e.renderResult&&(5<(t>i?Math.min(t-i,i+a-t):Math.min(i-t,t+a-i))&&(e.renderResult=null,e.renderTask=null),e.texture&&!s&&(e.texture.dispose(),e.texture=null)))})}}processRenderQueue(){const e=this.visiblePages;if(!this.renderingPage||!e[this.renderingPage]){const i=!1===this.renderingPage?0:200,a=Date.now();if(e.forEach((e,t)=>{a-e<i||(e=this.ensurePageEntry(t)).page&&!e.renderTask&&this.startRendering(t)}),!this.renderingPage){const r=this.renderQueue;var t,s;0!==r.length&&(t=r[0],(s=this.ensurePageEntry(t)).page&&(r.shift(),s.renderTask||this.startRendering(t)))}}}startRendering(e){if(this.renderingPage){const t=this.ensurePageEntry(this.renderingPage);t.renderTask.cancel()}this.renderingPage=e;const t=this.ensurePageEntry(e),{page:s,renderScale:i}=t,a=s.getViewport({scale:i}),r=(this.renderCanvas||(this.renderCanvas=document.createElement("canvas")),this.renderCanvas),n=r.getContext("2d");r.height=a.height,r.width=a.width;var o={canvasContext:n,viewport:a};const h=t.renderTask=s.render(o);h.promise.then(()=>{this.renderingPage=null,t.renderResult=n.getImageData(0,0,a.width,a.height),this.finishedRendering(e)},()=>{t.renderTask=null})}finishedRendering(e){this.visiblePages[e]&&this.drawAtScrollPosition()}adjustCardSize(e,t){var s=this.actor._cardData["depth"],i=1/Math.max(e,t),e=this.cardWidth=e*i,t=this.cardHeight=t*i;const a=this.substrateObj;a.geometry.dispose(),a.geometry=this.squareCornerGeometry(e,t,s),this.PAGE_GAP=t*this.actor.PAGE_GAP_PERCENT/100}squareCornerGeometry(e,t,s){var i=t/2,a=e/2,r=s/2;let n=new THREE.Shape,o=(n.moveTo(-i,-a),n.lineTo(-i,a),n.lineTo(i,a),n.lineTo(i,-a),n.lineTo(-i,-a),new THREE.LineCurve3(new THREE.Vector3(0,0,r),new THREE.Vector3(0,0,-r))),h=(o.arcLengthDivisions=3,new THREE.ExtrudeGeometry(n,{extrudePath:o}));return h.parameters.width=e,h.parameters.height=t,h.parameters.depth=s,h}ensurePageEntry(i){var e=this.pages[i];if(e)return e;const a={renderResult:null,renderTask:null};return this.pages[i]=a,this.pdf.getPage(i).then(e=>{var{width:e,height:t}=(a.page=e).getViewport({scale:1}),s=(a.width=e,a.height=t,Math.max(e,t)),s=this.TEXTURE_SIZE/s*.999;a.renderScale=s,a.aspectRatio=e/t,1===i&&this.adjustCardSize(e,t)}),a}onPointerDown(e){e.uv&&this.changePage(1)}onPointerWheel(e){if(this.pdf&&this.PAGE_GAP){var t=Date.now();if(this.cumulativeWheelDelta=(this.cumulativeWheelDelta||0)+e.deltaY,!(t-(this.lastPointerWheel||0)<50)){this.lastPointerWheel=t;let e=4*this.cumulativeWheelDelta/this.TEXTURE_SIZE*100;50<Math.abs(e)&&(e=50*Math.sign(e)),this.cumulativeWheelDelta=0,this.say("scrollByPercent",e)}}}onKeyDown(e){if(!e.repeat)switch(e.key){case"ArrowLeft":case"ArrowUp":this.changePage(-1);break;case"ArrowRight":case"ArrowDown":this.changePage(1)}}changePage(e){this.say("changePage",e)}onKeyUp(e){}update(){this.updateVisiblePages(),this.manageRenderState(),this.processRenderQueue()}destroy(){const e=this.substrateObj;e.geometry.dispose(),this.material.dispose(),this.pageMeshPool.forEach(e=>{e.geometry.dispose(),e.material.dispose()}),this.pages.forEach(e=>{e.texture&&e.texture.dispose()})}}]}]}}}]);